<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Institute Graph</title>
  <script src="https://unpkg.com/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
  <style>
    html, body, #cy { height: 100%; margin: 0; }
    #bar { position: fixed; top: 10px; left: 10px; background: white; border: 1px solid #ddd; border-radius: 10px; padding: 8px 10px; font: 14px system-ui; z-index: 10; }
    #bar b { margin-right: 8px; }
  </style>
</head>
<body>
  <div id="bar"><b>LOD:</b><span id="lod">—</span> <span style="opacity:.6">| колесо: zoom | клик: приближение | shift+клик: открыть</span></div>
  <div id="cy"></div>

<script>
const lodEl = document.getElementById('lod');

// пороги (подбираются)
const THRESH = { areasOnly: 0.75, labsOnly: 1.35 };

function showTypes(cy, typesToShow) {
  const all = ['area','lab','person'];

  for (const t of all) {
    const coll = cy.nodes(`[type="${t}"]`);
    typesToShow.includes(t) ? coll.show() : coll.hide();
  }

  cy.edges().hide();
  cy.edges().forEach(e => {
    if (!e.source().hidden() && !e.target().hidden()) e.show();
  });
}

function applyLOD(cy) {
  const z = cy.zoom();
  if (z < THRESH.areasOnly) {
    lodEl.textContent = 'Areas';
    showTypes(cy, ['area']);
  } else if (z < THRESH.labsOnly) {
    lodEl.textContent = 'Areas + Labs';
    showTypes(cy, ['area','lab']);
  } else {
    lodEl.textContent = 'Areas + Labs + People';
    showTypes(cy, ['area','lab','person']);
  }
}

function animateTo(cy, node, targetZoom) {
  cy.animate({ center: { eles: node }, zoom: targetZoom }, { duration: 450, easing: 'ease-in-out' });
}

fetch("data/graph.json")
  .then(r => r.json())
  .then(graph => {
    const cy = cytoscape({
      container: document.getElementById('cy'),
      elements: graph,
      layout: { name: 'cose', animate: false }, // позже можно заменить на preset/фиксированный
      wheelSensitivity: 0.2,
      style: [
        { selector: 'node', style: { 'label': 'data(label)', 'text-valign':'center', 'text-halign':'center', 'font-size': 12, 'background-color':'#fff', 'border-width':1, 'border-color':'#ccc', 'shape':'round-rectangle', 'padding':10 } },
        { selector: 'node[type="area"]', style: { 'font-size': 18, 'background-color':'#f7f7ff', 'border-color':'#bdbdfc', 'padding':18 } },
        { selector: 'node[type="lab"]',  style: { 'background-color':'#f8fff7', 'border-color':'#b7e3b0' } },
        { selector: 'node[type="person"]', style: { 'shape':'ellipse', 'width':18, 'height':18, 'padding':0, 'font-size': 9, 'background-color':'#fff7f7', 'border-color':'#f0b4b4' } },
        { selector: 'edge', style: { 'curve-style':'bezier', 'line-color':'#bbb', 'width': 2, 'opacity': 0.85 } }
      ]
    });

    // старт
    cy.fit(undefined, 40);
    applyLOD(cy);

    // обновление LOD по зуму (debounce)
    let raf = null;
    cy.on('zoom', () => {
      if (raf) cancelAnimationFrame(raf);
      raf = requestAnimationFrame(() => { applyLOD(cy); raf = null; });
    });

    // клик: приближение; shift+клик: открыть url
    cy.on('tap', 'node', (evt) => {
      const n = evt.target;
      const type = n.data('type');
      const url = n.data('url');

      if (evt.originalEvent && evt.originalEvent.shiftKey && url) {
        window.open(url, '_blank');
        return;
      }

      if (type === 'area') animateTo(cy, n, THRESH.areasOnly + 0.2);
      else if (type === 'lab') animateTo(cy, n, THRESH.labsOnly + 0.25);
      else cy.animate({ center: { eles: n } }, { duration: 300 });
    });
  })
  .catch(err => {
    document.body.innerHTML = "<pre style='padding:16px'>Ошибка загрузки graph.json:\n" + err + "</pre>";
  });
</script>
</body>
</html>